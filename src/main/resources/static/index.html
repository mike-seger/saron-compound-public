<html>
<head>
<script src="https://jsuites.net/v4/jsuites.js"></script>
<script src="https://jsuites.net/v4/jsuites.webcomponents.js"></script>
<script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-dsv@3"></script>
<link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />
<link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" />
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="jexcel-custom.css" type="text/css" />
<link rel="stylesheet" href="style.css" type="text/css" />
</head>
<body>

<input type="button" class="btn" onclick="importFile()" value="Upload"> SARON rates
<br /><br />

<div class="grid-container">
    <div id="saron-table"></div>
    <div id="link-table">
        SARON rate sources<br />
        <a href="https://www.six-group.com/exchanges/downloads/indexdata/hsrron.csv"
        >SARON rates 1999 - present (SIX)</a>
    </div>
</div>

<br />
<input type="button" class="btn" value="Download" onclick="exportFile()">
Compound rates from <input class="input" id='startdate'/>
to <input class="input" id='enddate' /> 
all start dates <input type="checkbox" class="btn" id='allStartDates' />

<jsuites-modal title="Message" closed="true" width="600" height="400">
    <div id="servertext"></div>
</jsuites-modal>

<script>
    // https://www.six-group.com/exchanges/indices/data_centre/swiss_reference_rates/reference_rates_en.html
    const saronTableDiv = document.getElementById('saron-table')
    const serverMessage = document.querySelector('jsuites-modal')
    const serverText = document.getElementById('servertext')
    const startDate = document.getElementById('startdate')
    const endDate = document.getElementById('enddate')
    const allStartDates = document.getElementById('allStartDates')

    jSuites.calendar(startDate,{ format: 'YYYY-MM-DD' })
    jSuites.calendar(endDate,{ format: 'YYYY-MM-DD' })

    const saronTable = jspreadsheet(document.getElementById('saron-table'), {
        defaultColAlign: 'left',
        minDimensions: [2, 26],
        allowInsertRow:true,
        allowManualInsertRow:true,
        allowInsertColumn:false,
        allowManualInsertColumn:false,
        allowDeleteRow:true,
        allowDeleteColumn:false,
        tableOverflow:true,
        columns: [
            {
                title: 'Date',
                name: 'Date',
                type: 'calendar',
                options: { format:'YYYY-MM-DD' },
                width:'120px',
            },
            {
                title: 'SARON Rate',
                name: 'SaronRate',
                type: 'numeric',
                //options: { format:'0.000000' },
                //mask:'0.000000',
                width:'120px',
                decimal:'.'
            },
        ],
        rowResize: false,
        columnDrag: false,
    });

    async function postForm(url, formData) {
        try {
            const response = await fetch(url, { body: formData, method: "POST" })
            const data = await response.text()
            if(response.status != 200) throw data;
            return data
        } catch (e) {
            console.log('error', e)
            messageDialog("Error sending request: "+e.message)
            return null
        }
    }

    function getSaronTable() {
        if(!saronTableDiv.children[0]) return undefined;
        return saronTableDiv.jexcel[0];
    }

    function uploadFile(file) {
        if( !(
                file.type === "text/tab-separated-values"
                || file.type === "text/csv"
                || file.type === "text/plain"
            )) {
            messageDialog("Unsupported file type: "+file.type)
            return
        }

        const reader = new FileReader();
        reader.readAsText(file);
        reader.onload = () => storeResults(reader.result);
    }

    function messageDialog(content) {
        serverText.innerText = ""
        if(content.trim().startsWith('<'))  {
            content = content.replace(/<[^>]+>/g, '')
                .replace(/^\s*$(?:\r\n?|\n)/gm,'')

            const newLineExpression = /\r\n|\n\r|\n|\r/g;
            const removeDuplicatedLines = (text) => {
                return text.split(newLineExpression)
                    .filter((item, index, array) => array.indexOf(item) === index)
                    .join('\n')
            };
            content = removeDuplicatedLines(content)
        }
        serverText.innerText = content
        serverMessage.modal.open()
    }

    function storeResults(data) {
        console.log(data)
        let csv = null
        if(data.startsWith("ISIN;CH0049613687;")) {
            csv = data.replace(/^ISIN;CH0049613687;.*$/mg, "")
                .replace(/^SYMBOL;SARON;;.*$/mg, "")
                .replace(/^NAME;Swiss.*$/mg, "")
                .trim()
            if(! csv.startsWith("Date;Close;")) {
                messageDialog("Expected Date;Close;... in SIX SARON CSV")
                return    
            }
            csv = csv.replace(/Date;Close;/mg, "Date;SaronRate;")
                .replace(/; */mg, ",")
                .replace(/^([^,]*),([^,]*),.*/mg, "$1,$2")
                .replace(/^(..)\.(..)\.([12]...)/mg, "$3-$2-$1")
            csv = d3.csvParse(csv)
            if(csv.length < 365) {
                messageDialog("Expected more that 365 rows in SIX SARON CSV")
                return                
            }
            saronTable.setData(csv)
        }
    }

    async function exportFile() {
        let formData = new FormData()
        formData.append('all', 'true')
        formData.append('allStartDates', allStartDates.checked)
        formData.append('startDate', startDate.value)
        formData.append('endDate', endDate.value)
        formData.append('rates', d3.csvFormatBody(saronTable.getData()))
        
        let response = await postForm("api/v1", formData)
        if(response != null) {
            console.log(response)   
            const data = JSON.parse(response)
            const result = d3.csvFormat(data)
            let mimetype = "text/csv"
            const timeStamp =new Date().toISOString().substring(0,16).replaceAll(/[:.-]/g, '_').replace('T', '-');
            const dlLink = document.createElement('a')
            dlLink.href = 'data:'+mimetype+';charset=utf-8,' + encodeURI(result)
            dlLink.target = '_blank'
            dlLink.download = 'saron-compound-'+startdate.value+'_'+endDate.value+'_'+ timeStamp +'.csv'
            dlLink.click()
            dlLink.remove()
        }
    }

    function importFile() {
        let input = document.createElement('input')
        input.type = 'file'
        input.accept = ".csv, .tsv, .txt"
        input.onchange = _this => {	uploadFile(input.files[0]);	}
        input.click()
    }

</script>
</body>
</html>
